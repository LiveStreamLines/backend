<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Simple</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 100%;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #4facfe;
            color: white;
            border-radius: 5px;
        }
        
        .header h2 {
            margin: 0 0 5px 0;
            font-size: 1.2em;
        }
        
        .header p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .image-wrapper {
            text-align: center;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-image {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }
        
        .loading {
            color: #666;
            font-size: 1em;
        }
        
        .error {
            color: #e74c3c;
            font-size: 1em;
        }
        
        .info {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Live Camera</h2>
            <p id="cameraInfo">Loading...</p>
        </div>
        
        <div class="image-wrapper">
            <p class="loading" id="loading">Loading image...</p>
            <img id="image" class="camera-image" style="display:none;" alt="Camera Feed">
            <p class="error" id="error" style="display:none;">Failed to load image</p>
        </div>
        
        <div class="info" id="info">Auto-refresh: 30 minutes</div>
    </div>

    <script>
        // Get parameters from URL
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('projectId') || 'your-project-id';
        const cameraId = params.get('cameraId') || 'your-camera-id';
        const token = params.get('token') || 'your-auth-token';
        const developerId = 'seeb';
        
        // Update camera info
        document.getElementById('cameraInfo').textContent = `${projectId} | ${cameraId}`;
        
        // Function to get date/time in required format
        function getDateTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            return {
                day: year + month + day,
                time: hours + minutes + seconds
            };
        }
        
        // Function to load the latest image
        async function loadImage() {
            const loading = document.getElementById('loading');
            const image = document.getElementById('image');
            const error = document.getElementById('error');
            const info = document.getElementById('info');
            
            // Show loading
            loading.style.display = 'block';
            image.style.display = 'none';
            error.style.display = 'none';
            
            try {
                // Get time from 1 hour ago
                const now = new Date();
                const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                const dt = getDateTime(oneHourAgo);
                
                // Call API
                const response = await fetch(`https://lsl-platform.com/backend/api/get-image/${projectId}/${cameraId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        day1: dt.day,
                        time1: dt.time
                    })
                });
                
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                
                if (data.images && data.images.length > 0) {
                    // Get last image
                    const lastImage = data.images[data.images.length - 1];
                    const imageUrl = `https://lsl-platform.com/backend/media/upload/${developerId}/${projectId}/${cameraId}/large/${lastImage}.jpg`;
                    
                    // Load image
                    image.onload = function() {
                        loading.style.display = 'none';
                        image.style.display = 'block';
                        
                        // Update info with timestamp
                        const timestamp = new Date();
                        info.textContent = `Last updated: ${timestamp.toLocaleTimeString()} | Auto-refresh: 30 min`;
                    };
                    
                    image.onerror = function() {
                        loading.style.display = 'none';
                        error.style.display = 'block';
                        error.textContent = 'Failed to load image';
                    };
                    
                    image.src = imageUrl;
                } else {
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    error.textContent = 'No images available';
                }
            } catch (err) {
                console.error('Error:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Connection error';
            }
        }
        
        // Load image on page load
        loadImage();
        
        // Auto-refresh every 30 minutes
        setInterval(loadImage, 30 * 60 * 1000);
    </script>
</body>
</html>

